<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Activity Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="number"], input[type="checkbox"], input[type="text"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        input[type="checkbox"] {
            width: auto;
        }
        button {
            width: 100%;
            padding: 10px;
            background: #28a745;
            color: #fff;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #218838;
        }
        .undo-button {
            width: auto;
            padding: 5px;
            background: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            font-size: 16px;
            margin-bottom: 10px;
            display: inline-block;
            text-align: center;
        }
        .undo-button:hover {
            background: #0056b3;
        }
        .result, .points-earned, .jour {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
        }
        .result {
            font-size: 24px;
        }
        .points-earned {
            font-size: 20px;
        }
        .jour {
            font-size: 20px;
        }
        #chart-container {
            margin-top: 20px;
            text-align: center;
        }
        #chart {
            max-width: 100%;
            height: 400px;
        }
        #user-selection, #tracker-container, #add-user-container {
            display: none;
        }
        #user-selection {
            display: block;
        }
        .user-list button {
            display: block;
            margin: 5px 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase App (SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <!-- Firebase Realtime Database (SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>
</head>
<body>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
        import Chart from "https://cdn.jsdelivr.net/npm/chart.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDJhZSCb4X11Mp0cmqWQgu4Z2boEmyX9ps",
            authDomain: "mois1gagnant.firebaseapp.com",
            projectId: "mois1gagnant",
            storageBucket: "mois1gagnant.appspot.com",
            messagingSenderId: "196066005100",
            appId: "1:196066005100:web:59658778bbbdba6e6ac849",
            measurementId: "G-YJJLD8E2GD"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const analytics = getAnalytics(app);

        let currentUser = null;
        let totalPoints = 0;
        let dailyPointsHistory = [];
        let submitCount = 0;
        let undoClickCount = 0;
        let chart = null;

        function writeUserData(userId, name, email, imageUrl) {
            set(ref(db, 'users/' + userId), {
                username: name,
                email: email,
                profile_picture: imageUrl
            });
        }

        function addUser() {
            const userName = document.getElementById('userName').value.trim();
            if (!userName) {
                alert('Please enter a user name.');
                return;
            }

            const userRef = ref(db, 'users/' + userName);
            set(userRef, {
                username: userName,
                email: '', // Ajoutez des valeurs si nécessaire
                profile_picture: '' // Ajoutez des valeurs si nécessaire
            }).then(() => {
                alert('User added successfully!');
                updateUserList();
                document.getElementById('userName').value = '';
                document.getElementById('add-user-container').style.display = 'none';
            }).catch((error) => {
                console.error('Error adding user:', error);
            });
        }

        function loadUserData() {
            const usersRef = ref(db, 'users');
            onValue(usersRef, (snapshot) => {
                const users = snapshot.val() || {};
                updateUserList(users);
            });
        }

        function updateUserList(users) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            for (const userId in users) {
                const userButton = document.createElement('button');
                userButton.textContent = userId;
                userButton.onclick = () => selectUser(userId);
                userList.appendChild(userButton);
            }
        }

        function selectUser(user) {
            currentUser = user;
            document.getElementById('user-selection').style.display = 'none';
            document.getElementById('tracker-container').style.display = 'block';
            loadUserSpecificData();
        }

        function loadUserSpecificData() {
            const userRef = ref(db, 'users/' + currentUser);
            onValue(userRef, (snapshot) => {
                const userData = snapshot.val() || {};
                totalPoints = userData.totalPoints || 0;
                dailyPointsHistory = userData.dailyPointsHistory || [];
                submitCount = userData.submitCount || 0;
                undoClickCount = userData.undoClickCount || 0;
                updateDisplay();
                destroyChart();
                createOrUpdateChart();
            });
        }

        function updateUserSpecificData() {
            const userRef = ref(db, 'users/' + currentUser);
            set(userRef, {
                username: currentUser,
                totalPoints,
                dailyPointsHistory,
                submitCount,
                undoClickCount
            }).catch((error) => {
                console.error('Error updating user data:', error);
            });
        }

        function updateDisplay() {
            document.getElementById('result').textContent = `Total Points: ${totalPoints}`;
            document.getElementById('points-earned').textContent = `${dailyPointsHistory[dailyPointsHistory.length - 1] || 0} points`;
            document.getElementById('jour').textContent = `Jour: ${submitCount}`;
        }

        function submitDailyData() {
            submitCount += 1;
            undoClickCount = 0;
            const sportHours = parseInt(document.getElementById('sportHours').value) || 0;
            const revisionHours = parseInt(document.getElementById('revisionHours').value) || 0;
            const travailHours = parseInt(document.getElementById('travailHours').value) || 0;
            const pratiqueReligieuse = document.getElementById('pratiqueReligieuse').checked;
            const lectureHours = parseInt(document.getElementById('lectureHours').value) || 0;
            const alimentationSaine = document.getElementById('alimentationSaine').checked;

            let dailyPoints = 0;

            if (!pratiqueReligieuse) {
                alert("Pratique religieuse non accomplie. Total des points pour la journée est 0.");
                dailyPoints = 0;
            } else {
                dailyPoints += sportHours * 10;
                dailyPoints += revisionHours * 5;
                dailyPoints += travailHours * 8;
                dailyPoints += lectureHours * 2;
                if (alimentationSaine) {
                    dailyPoints += 5;
                }
            }

            dailyPointsHistory.push(dailyPoints);
            totalPoints += dailyPoints;

            updateDisplay();
            updateUserSpecificData();
            destroyChart();
            createOrUpdateChart();

            document.getElementById('tracker-container').style.display = 'none';
            document.getElementById('user-selection').style.display = 'block';
        }

        function undo() {
            if (dailyPointsHistory.length > 0) {
                dailyPointsHistory.pop();
                totalPoints = dailyPointsHistory.reduce((sum, points) => sum + points, 0);
                undoClickCount += 1;
                updateDisplay();
                updateUserSpecificData();
                destroyChart();
                createOrUpdateChart();
            }
        }

        function destroyChart() {
            if (chart) {
                chart.destroy();
            }
        }

        function createOrUpdateChart() {
            const ctx = document.getElementById('chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyPointsHistory.map((_, index) => `Jour ${index + 1}`),
                    datasets: [{
                        label: 'Points quotidiens',
                        data: dailyPointsHistory,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('submit-button').addEventListener('click', submitDailyData);
            document.getElementById('undo-button').addEventListener('click', undo);
            document.getElementById('add-user-button').addEventListener('click', () => {
                document.getElementById('add-user-container').style.display = 'block';
            });
            document.getElementById('save-user-button').addEventListener('click', addUser);

            loadUserData();
        });
    </script>
    <div class="container">
        <div id="user-selection">
            <h1>Select User</h1>
            <div id="userList" class="user-list">
                <!-- Liste des utilisateurs sera remplie ici -->
            </div>
            <button id="add-user-button">Add User</button>
        </div>
        <div id="add-user-container">
            <h2>Add New User</h2>
            <div class="form-group">
                <label for="userName">User Name</label>
                <input type="text" id="userName" placeholder="Enter user name">
            </div>
            <button id="save-user-button">Save User</button>
        </div>
        <div id="tracker-container">
            <h1>Daily Activity Tracker</h1>
            <div class="form-group">
                <label for="sportHours">Hours of Sport</label>
                <input type="number" id="sportHours" placeholder="Enter hours">
            </div>
            <div class="form-group">
                <label for="revisionHours">Hours of Revision</label>
                <input type="number" id="revisionHours" placeholder="Enter hours">
            </div>
            <div class="form-group">
                <label for="travailHours">Hours of Work</label>
                <input type="number" id="travailHours" placeholder="Enter hours">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="pratiqueReligieuse">
                    Pratique Religieuse
                </label>
            </div>
            <div class="form-group">
                <label for="lectureHours">Hours of Reading</label>
                <input type="number" id="lectureHours" placeholder="Enter hours">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="alimentationSaine">
                    Healthy Eating
                </label>
            </div>
            <button id="submit-button">Submit</button>
            <button id="undo-button" class="undo-button">Undo</button>
            <div class="result" id="result">Total Points: 0</div>
            <div class="points-earned" id="points-earned">Points Earned Today: 0</div>
            <div class="jour" id="jour">Jour: 0</div>
            <div id="chart-container">
                <canvas id="chart"></canvas>
            </div>
        </div>
    </div>
</body>
</html>
